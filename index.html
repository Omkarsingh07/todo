<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Todo Manager</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Daily Todo Manager</h1>
            <p>Plan your morning, review in night</p>
            <div class="date-selector">
                <input type="date" id="selectedDate" />
            </div>
        </div>

        <div class="main-content">
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>

            <div class="add-todo">
                <input type="text" class="todo-input" id="todoInput" placeholder="Add your daily task here..." />
                <button class="add-btn" onclick="addTodo()">‚ûï Add Task</button>
            </div>

            <div class="todo-list" id="todoList">
                <div class="empty-state" id="emptyState">
                    <div style="font-size: 3em;">üìã</div>
                    <h3>No tasks for today</h3>
                    <p>Add your first task to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div id="completionModal" class="modal">
        <div class="modal-content">
            <h3>Task Completion Review</h3>
            <p id="taskTitle"></p>
            <label for="completionPercentage">How much have you completed? (%)</label>
            <input type="number" id="completionPercentage" class="percentage-input" min="0" max="100" placeholder="Enter percentage (0-100)" />
            
            <div id="reasonSection" style="display: none;">
                <label for="incompleteReason">Why haven't you completed this task?</label>
                <textarea id="incompleteReason" class="reason-input" rows="3" placeholder="Please explain why the task is incomplete..."></textarea>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="submitCompletion()">Submit</button>
                <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentTodos = [];
        let currentTaskId = null;
        const API_BASE = '/api';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            loadTodos();
            updateStats();
        });

        // Date change handler
        document.getElementById('selectedDate').addEventListener('change', function() {
            loadTodos();
            updateStats();
        });

        // Enter key handler for todo input
        document.getElementById('todoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // Completion percentage change handler
        document.getElementById('completionPercentage').addEventListener('input', function() {
            const percentage = parseInt(this.value) || 0;
            const reasonSection = document.getElementById('reasonSection');
            
            if (percentage < 100) {
                reasonSection.style.display = 'block';
                document.getElementById('incompleteReason').required = true;
            } else {
                reasonSection.style.display = 'none';
                document.getElementById('incompleteReason').required = false;
                document.getElementById('incompleteReason').value = '';
            }
        });

        function getCurrentDate() {
            return document.getElementById('selectedDate').value;
        }

        async function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a task!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/todos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        date: getCurrentDate()
                    })
                });

                if (response.ok) {
                    input.value = '';
                    await loadTodos();
                    await updateStats();
                } else {
                    throw new Error('Failed to add todo');
                }
            } catch (error) {
                console.error('Error adding todo:', error);
                alert('Failed to add task. Please try again.');
            }
        }

        async function deleteTodo(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const response = await fetch(`${API_BASE}/todos/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadTodos();
                        await updateStats();
                    } else {
                        throw new Error('Failed to delete todo');
                    }
                } catch (error) {
                    console.error('Error deleting todo:', error);
                    alert('Failed to delete task. Please try again.');
                }
            }
        }

        function markComplete(id) {
            const todo = currentTodos.find(t => t.id === id);
            
            if (todo) {
                currentTaskId = id;
                document.getElementById('taskTitle').textContent = `"${todo.text}"`;
                document.getElementById('completionPercentage').value = '';
                document.getElementById('incompleteReason').value = '';
                document.getElementById('reasonSection').style.display = 'none';
                document.getElementById('completionModal').style.display = 'block';
            }
        }

        async function submitCompletion() {
            const percentage = parseInt(document.getElementById('completionPercentage').value);
            const reason = document.getElementById('incompleteReason').value.trim();

            if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('Please enter a valid percentage between 0 and 100!');
                return;
            }

            if (percentage < 100 && !reason) {
                alert('Please explain why the task is incomplete!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/todos/${currentTaskId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        completionPercentage: percentage,
                        reason: reason
                    })
                });

                if (response.ok) {
                    await loadTodos();
                    await updateStats();
                    closeModal();
                } else {
                    throw new Error('Failed to update todo');
                }
            } catch (error) {
                console.error('Error updating todo:', error);
                alert('Failed to update task. Please try again.');
            }
        }

        function closeModal() {
            document.getElementById('completionModal').style.display = 'none';
            currentTaskId = null;
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            const emptyState = document.getElementById('emptyState');

            if (currentTodos.length === 0) {
                todoList.innerHTML = '';
                todoList.appendChild(emptyState);
                return;
            }

            todoList.innerHTML = '';

            currentTodos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = `todo-item ${todo.completed ? (todo.completion_percentage === 100 ? 'completed' : 'incomplete') : ''}`;
                
                let statusHtml = '';
                if (todo.completed) {
                    const completedDate = todo.completed_at ? new Date(todo.completed_at).toLocaleString() : 'Unknown';
                    statusHtml = `
                        <div class="todo-status">
                            <span class="completion-percentage">Completion: ${todo.completion_percentage}%</span>
                            ${todo.completion_percentage < 100 && todo.reason ? `<br><span class="reason-text">Reason: ${todo.reason}</span>` : ''}
                            <br><small>Completed: ${completedDate}</small>
                        </div>
                    `;
                }

                todoItem.innerHTML = `
                    <div class="todo-content">
                        <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
                        <div class="todo-actions">
                            ${!todo.completed ? `<button class="complete-btn" onclick="markComplete(${todo.id})">‚úì Complete</button>` : ''}
                            <button class="delete-btn" onclick="deleteTodo(${todo.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    ${statusHtml}
                `;

                todoList.appendChild(todoItem);
            });
        }

        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/stats/${getCurrentDate()}`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalTasks').textContent = stats.total || 0;
                    document.getElementById('completedTasks').textContent = stats.completed || 0;
                    document.getElementById('pendingTasks').textContent = stats.pending || 0;
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function loadTodos() {
            try {
                const response = await fetch(`${API_BASE}/todos/${getCurrentDate()}`);
                if (response.ok) {
                    currentTodos = await response.json();
                    renderTodos();
                } else {
                    throw new Error('Failed to load todos');
                }
            } catch (error) {
                console.error('Error loading todos:', error);
                currentTodos = [];
                renderTodos();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('completionModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>